<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body {
            font-family: Arial;
        }

        /* Style the tab */
        .tab {
            overflow: hidden;
            border: 1px solid #ccc;
            background-color: #f1f1f1;
        }

        /* Style the buttons inside the tab */
        .tab button {
            background-color: inherit;
            float: left;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 14px 16px;
            transition: 0.3s;
            font-size: 17px;
        }

        /* Change background color of buttons on hover */
        .tab button:hover {
            background-color: #ddd;
        }

        /* Create an active/current tablink class */
        .tab button.active {
            background-color: #ccc;
        }

        /* Style the tab content */
        .tabcontent {
            display: none;
            padding: 16px 12px;
            border: 1px solid #ccc;
            border-top: none;
        }

        table {
            font-family: arial, sans-serif;
            border-collapse: collapse;
            width: 100%;
        }

        td,
        th {
            border: 1px solid #dddddd;
            text-align: left;
            padding: 8px;
        }

        tr:nth-child(even) {
            background-color: #dddddd;
        }
    </style>
</head>

<body>

    <h2>Population Report Tool</h2>
    <p>Select a tab to see related reports.</p>

    <div class="tab">
        <button class="tablinks" onclick="openTab(event, 'Country')">Country</button>
        <button class="tablinks" onclick="openTab(event, 'City')">City</button>
        <button class="tablinks" onclick="openTab(event, 'CapitalCity')">CapitalCity</button>
        <button class="tablinks" onclick="openTab(event, 'Population')">Population</button>
        <button class="tablinks" onclick="openTab(event, 'Language')">Language</button>
    </div>

    <div id="Country" class="tabcontent">
        <label for="report">Choose a query:</label>
        <select name="report">
            <option value="country1">All the countries in the world organised by largest population to smallest</option>
            <option value="country2-continent">All the countries in a continent organised by largest population to
                smallest
            </option>
            <option value="country3-region">All the countries in a region organised by largest population to smallest
            </option>
            <option value="country1-n">The top N populated countries in the world where N is provided by the user
            </option>
            <option value="country2-n-continent">The top N populated countries in a continent where N is provided by the
                user
            </option>
            <option value="country3-n-region">The top N populated countries in a region where N is provided by the user
            </option>

        </select>
        <span class="areaArgContainer">
            <label for="areaArg"></label>
            <input name="areaArg" value="" />
        </span>
        <span class="limitArgContainer">
            <label for="limitArg">N:</label>
            <input name="limitArg" type="number" value="10" />
        </span>
        <button onclick="executeCommand()">Execute Query</button>
        <h3>Country Report</h3>
        <table style="width:100%">
        </table>
    </div>

    <div id="City" class="tabcontent">
        <label for="report">Choose a query:</label>
        <select name="report">
            <option value="city1">All the cities in the world organised by largest population to smallest</option>
            <option value="city2-continent">All the cities in a continent organised by largest population to smallest
            </option>
            <option value="city3-region">All the cities in a region organised by largest population to smallest</option>
            <option value="city4-country">All the cities in a country organised by largest population to smallest
            </option>
            <option value="city5-district">All the cities in a district organised by largest population to smallest
            </option>
            <option value="city1-n">The top N populated cities in the world</option>
            <option value="city2-n-continent">The top N populated cities in a continent</option>
            <option value="city3-n-region">The top N populated cities in a region</option>
            <option value="city4-n-country">The top N populated cities in a country</option>
            <option value="city5-n-district">The top N populated cities in a district</option>
        </select>
        <span class="areaArgContainer">
            <label for="areaArg"></label>
            <input name="areaArg" value="" />
        </span>
        <span class="limitArgContainer">
            <label for="limitArg">N:</label>
            <input name="limitArg" type="number" value="10" />
        </span>
        <button onclick="executeCommand()">Execute Query</button>
        <h3>City Report</h3>
        <table style="width:100%">
        </table>
    </div>

    <div id="CapitalCity" class="tabcontent">
        <label for="report">Choose a query:</label>
        <select name="report">
            <option value="capitalcity1">All the capital cities in the world organised by largest population to smallest
            </option>
            <option value="capitalcity2-continent">All the capital cities in a continent organised by largest population
                to smallest
            </option>
            <option value="capitalcity3-region">All the capital cities in a region organised by largest population to
                smallest</option>
            <option value="capitalcity1-n">The top N populated capital cities in the world</option>
            <option value="capitalcity2-n-continent">The top N populated capital cities in a continent</option>
            <option value="capitalcity3-n-region">The top N populated capital cities in a region</option>

        </select>
        <span class="areaArgContainer">
            <label for="areaArg"></label>
            <input name="areaArg" value="" />
        </span>
        <span class="limitArgContainer">
            <label for="limitArg">N:</label>
            <input name="limitArg" type="number" value="10" />
        </span>
        <button onclick="executeCommand()">Execute Query</button>
        <h3>Capital City Report</h3>
        <table style="width:100%">
        </table>
    </div>

    <div id="Population" class="tabcontent">
        <label for="report">Choose a query:</label>
        <select name="report">
            <option value="population1">The population of people, people living in cities, and people not living in
                cities in each continent</option>
            <option value="population2">The population of people, people living in cities, and people not
                living in cities in each region</option>
            <option value="population3">The population of people, people living in cities, and people not living
                in cities in each country</option>

            <option value="population9">Total population of the world</option>
            <option value="population4-city">The population of a city</option>
            <option value="population5-district">The total population of a district</option>
            <option value="population6-country">The total population of a country</option>
            <option value="population7-region">The total population of a region</option>
            <option value="population8-continent">The total population of a continent</option>
        </select>
        <span class="areaArgContainer">
            <label for="areaArg"></label>
            <input name="areaArg" value="" />
        </span>
        <span class="limitArgContainer">
            <label for="limitArg">N:</label>
            <input name="limitArg" type="number" value="10" />
        </span>
        <button onclick="executeCommand()">Execute Query</button>
        <h3>Population Report</h3>
        <table style="width:100%">
        </table>
    </div>

    <div id="Language" class="tabcontent">
        <select style="display: none;"><option value="language"></option></select>
        <button onclick="executeCommand()">Execute Query</button>
        <h3>Language Report</h3>
        <table style="width:100%">
        </table>
    </div>

    <script>
        var url = location.protocol + '//' + location.hostname + (location.port ? ':' + location.port : '');
        var columnsByCategory = {
            "Country": ["Code", "Name", "Continent", "Region", "Population", "Capital"],
            "City": ["Name", "Country", "District", "Population"],
            "CapitalCity": ["Name", "Country", "Population"],
            "Population": ["Name", "TotalPop", "CityPop", "NonCityPop"],
            "Language": ["Name", "Population", "Percent"],
        }
        var currentTab = 'Country';

        // Code for this function is taken from https://stackoverflow.com/a/8497474
        // Return array of string values, or NULL if CSV string not well formed.
        function CSVtoArray(text) {
            var re_valid = /^\s*(?:'[^'\\]*(?:\\[\S\s][^'\\]*)*'|"[^"\\]*(?:\\[\S\s][^"\\]*)*"|[^,'"\s\\]*(?:\s+[^,'"\s\\]+)*)\s*(?:,\s*(?:'[^'\\]*(?:\\[\S\s][^'\\]*)*'|"[^"\\]*(?:\\[\S\s][^"\\]*)*"|[^,'"\s\\]*(?:\s+[^,'"\s\\]+)*)\s*)*$/;
            var re_value = /(?!\s*$)\s*(?:'([^'\\]*(?:\\[\S\s][^'\\]*)*)'|"([^"\\]*(?:\\[\S\s][^"\\]*)*)"|([^,'"\s\\]*(?:\s+[^,'"\s\\]+)*))\s*(?:,|$)/g;

            // Return NULL if input string is not well formed CSV string.
            if (!re_valid.test(text)) return null;

            var a = []; // Initialize array to receive values.
            text.replace(re_value, // "Walk" the string using replace with callback.
                function (m0, m1, m2, m3) {

                    // Remove backslash from \' in single quoted values.
                    if (m1 !== undefined) a.push(m1.replace(/\\'/g, "'"));

                    // Remove backslash from \" in double quoted values.
                    else if (m2 !== undefined) a.push(m2.replace(/\\"/g, '"'));
                    else if (m3 !== undefined) a.push(m3);
                    return ''; // Return empty string.
                });

            // Handle special case of empty last value.
            if (/,\s*$/.test(text)) a.push('');
            return a;
        };

        async function executeCommand() {
            var command = document.querySelector(`#${currentTab} select`).value;
            var split = command.split("-")

            let args = [];

            if (command.includes("-n")) {
                var limitArg = document.querySelector(`#${currentTab} .limitArgContainer input`).value;
                args.push(`limit=${limitArg}`);
            }

            if (command.includes("-continent")) {
                var value = document.querySelector(`#${currentTab} .areaArgContainer input`).value;
                args.push(`continent=${value}`);
            }
            else if (command.includes("-region")) {
                var value = document.querySelector(`#${currentTab} .areaArgContainer input`).value;
                args.push(`region=${value}`);
            }
            else if (command.includes("-country")) {
                var value = document.querySelector(`#${currentTab} .areaArgContainer input`).value;
                args.push(`country=${value}`);
            }
            else if (command.includes("-district")) {
                var value = document.querySelector(`#${currentTab} .areaArgContainer input`).value;
                args.push(`district=${value}`);
            }
            else if (command.includes("-city")) {
                var value = document.querySelector(`#${currentTab} .areaArgContainer input`).value;
                args.push(`city=${value}`);
            }

            command = split[0]
            console.log("Executing command: ", command);
            var result = await fetch(`${url}/api/${command}?${args.join("&")}`).then(_ => _.text());
            populateTable(result);
        }

        function populateTable(result) {
            var columns = columnsByCategory[currentTab];

            let html = ``

            html += `<tr>`;
            columns.forEach(col => {
                html += `<th>${col}</th>`
            });
            html += `</tr>`;

            result.split("\n").forEach(row => {
                var columns = CSVtoArray(row);
                html += `<tr>`;
                columns.forEach(col => {
                    html += `<td>${col.replace(/["]+/g, '')}</td>`
                })
                html += `</tr>`;
            })

            var table = document.querySelector(`#${currentTab} table`);
            table.innerHTML = html;
        }

        function setupTab(tab) {
            var querySelect = document.querySelector(`#${tab} select`);
            if (querySelect != null) {
                var limitArgContainer = document.querySelector(`#${tab} .limitArgContainer`);
                limitArgContainer.style = "display: none;"

                var areaArgContainer = document.querySelector(`#${tab} .areaArgContainer`);
                areaArgContainer.style = "display: none;"

                querySelect.onchange = () => {
                    if (querySelect.value.includes("-n")) {
                        limitArgContainer.style = "display: inline;"
                    }
                    else {
                        limitArgContainer.style = "display: none;"
                    }

                    if (querySelect.value.includes("-continent")) {
                        areaArgContainer.style = "display: inline;"
                        document.querySelector(`#${tab} .areaArgContainer label`).innerHTML = "Continent: ";
                    }
                    else if (querySelect.value.includes("-region")) {
                        areaArgContainer.style = "display: inline;"
                        document.querySelector(`#${tab} .areaArgContainer label`).innerHTML = "Region: ";
                    }
                    else if (querySelect.value.includes("-country")) {
                        areaArgContainer.style = "display: inline;"
                        document.querySelector(`#${tab} .areaArgContainer label`).innerHTML = "Country: ";
                    }
                    else if (querySelect.value.includes("-district")) {
                        areaArgContainer.style = "display: inline;"
                        document.querySelector(`#${tab} .areaArgContainer label`).innerHTML = "District: ";
                    }
                    else if (querySelect.value.includes("-city")) {
                        areaArgContainer.style = "display: inline;"
                        document.querySelector(`#${tab} .areaArgContainer label`).innerHTML = "City: ";
                    }

                    else {
                        areaArgContainer.style = "display: none;"
                    }

                };
            }
        }

        function openTab(evt, tabName) {
            currentTab = tabName;
            var i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tabcontent");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            tablinks = document.getElementsByClassName("tablinks");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.className += " active";
        }

        setupTab("Country")
        setupTab("City")
        setupTab("CapitalCity")
        setupTab("Population")
        setupTab("Language")

        openTab({ currentTarget: document.getElementsByClassName("tablinks")[0] }, 'Country')
    </script>

</body>

</html>